# .copilot-instructions.md

## Project Context

**Repository**: pplx-unofficial-sdk  
**Purpose**: Unofficial TypeScript SDK for Perplexity AI  
**Protocol**: 2.18  
**Tech Stack**: TypeScript 5.3+, Node 18+, native fetch/SSE APIs

## Current Status (85% complete)

### ✅ Implemented
- REST API Client (410 LOC, 24 endpoints)
- SSE Streaming Client (682 LOC, protocol 2.18)
- Unified SDK entry point (204 LOC)
- Examples and documentation

### ⏳ Remaining
- OAuth Connectors full implementation (~396 LOC)
- Unit tests (Vitest)
- Integration tests
- CI/CD pipeline

## Architecture

```
src/
├── index.ts                  # Unified SDK (PplxSDK class)
├── pplx-rest-client.ts       # REST API (24 endpoints) ✅
├── pplx-client.ts            # SSE Streaming (search, followUp, reconnect) ✅
└── pplx-connectors-client.ts # OAuth Connectors (9 providers) ⏳ STUB
```

## Code Style & Conventions

### TypeScript
- Strict mode enabled
- No `any` types (use `unknown` and type guards)
- Explicit return types for public APIs
- JSDoc comments for all public methods
- Use `interface` for objects, `type` for unions/intersections

### Async Patterns
- Use `async/generator` for streaming/pagination
- Native `fetch` API (no axios/node-fetch)
- `AbortController` for cancellation
- Error handling with custom error classes

### File Organization
- One export per file for tree-shaking
- Re-export from index.ts
- Keep LOC under 800 per file
- Separate types in dedicated sections

### Naming
- PascalCase for classes/interfaces
- camelCase for functions/variables
- SCREAMING_SNAKE_CASE for constants
- Prefix internal methods with `_` or `private`

## API Design Principles

### REST Client Pattern
```typescript
class PplxRestClient {
  private baseUrl: string;
  private headers: Record<string, string>;
  
  async request<T>(endpoint: string, options?: RequestInit): Promise<T> {
    // Centralized error handling
  }
  
  // Public methods use request() internally
  async getThread(uuid: string): Promise<Thread> {
    return this.request(`/rest/threads/${uuid}`);
  }
}
```

### SSE Streaming Pattern
```typescript
async *search(query: string, options?: SearchOptions): AsyncGenerator<Entry> {
  const stream = this.createSSEStream({ path, params });
  for await (const entry of stream) {
    yield entry;
  }
}
```

### Error Handling
```typescript
export class PplxError extends Error {
  constructor(
    message: string,
    public code?: string,
    public details?: any
  ) {
    super(message);
    this.name = 'PplxError';
  }
}

// Usage
if (!response.ok) {
  throw new PplxFetchError(
    `HTTP ${response.status}: ${response.statusText}`,
    response.status,
    { url }
  );
}
```

## Testing Strategy

### Unit Tests (Vitest)
```typescript
import { describe, it, expect, vi } from 'vitest';

describe('PplxRestClient', () => {
  it('should fetch thread by UUID', async () => {
    const client = createRestClient();
    const thread = await client.getThread('uuid');
    expect(thread.uuid).toBe('uuid');
  });
});
```

### Mocking
- Mock `fetch` globally for REST tests
- Mock SSE `ReadableStream` for streaming tests
- Use `vi.fn()` for spy/stub patterns

## Implementation Guidelines

### For OAuth Connectors (Issue #1)

**Reference Files**:
- `src/pplx-connectors-client.ts` (current stub, 218 LOC)
- Reverse-engineered from `spa-shell-Cc8l94kf.js`

**Required Implementation**:
1. **OAuth Flow** (~150 LOC)
   - `authorize(connectorId)` - Start OAuth
   - `handleCallback(code, state)` - Complete OAuth
   - `disconnect(connectorId)` - Revoke access

2. **File Operations** (~120 LOC)
   - `listFiles(connectorId, options)` - Async generator
   - `syncFiles(connectorId, fileIds)` - Sync to Perplexity
   - `getPickerConfig(connectorId)` - File picker UI config

3. **Connector Status** (~60 LOC)
   - `getStatus(connectorId)` - Connection status
   - `validateConnection(connectorId)` - Health check

4. **Types** (~66 LOC already defined in stub)
   - `ConnectorDefinition` ✅
   - `ConnectorStatus`
   - `ConnectorFile`
   - `OAuthConfig`

**9 Connectors to Support**:
```typescript
const CONNECTORS = [
  'google_drive',    // OAuth: Google, Scopes: drive.readonly
  'microsoft_365',   // OAuth: Microsoft, Scopes: Files.Read.All
  'notion',          // OAuth: Notion, Scopes: read_content
  'confluence',      // OAuth: Atlassian, Scopes: read:confluence-content.all
  'jira',            // OAuth: Atlassian, Scopes: read:jira-work
  'github',          // OAuth: GitHub, Scopes: repo
  'slack',           // OAuth: Slack, Scopes: files:read
  'dropbox',         // OAuth: Dropbox, Scopes: files.metadata.read
  'box'              // OAuth: Box, Scopes: root_readwrite
];
```

**Key Endpoints**:
- `GET /rest/connectors` - List all
- `POST /rest/connectors/{id}/authorize` - Start OAuth
- `GET /rest/connectors/{id}/callback` - OAuth callback
- `GET /rest/connectors/{id}/files` - List files (paginated)
- `POST /rest/connectors/{id}/sync` - Sync selected files

### For Tests

**Structure**:
```
tests/
├── unit/
│   ├── rest-client.test.ts
│   ├── sse-client.test.ts
│   └── connectors-client.test.ts
├── integration/
│   ├── full-conversation.test.ts
│   └── oauth-flow.test.ts
└── helpers/
    ├── mock-fetch.ts
    └── mock-sse-stream.ts
```

**Coverage Target**: >80%

### For CI/CD

**GitHub Actions Workflow** (`.github/workflows/ci.yml`):
```yaml
name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run typecheck
      - run: npm test
      - run: npm run build
```

## Protocol Specifications

### SSE Protocol 2.18

**Request Format**:
```typescript
GET /rest/sse/perplexity/ask?query_str=...&version=2.18&...
Accept: text/event-stream
```

**Response Format**:
```
data: {"uuid":"...","status":"STREAMING","blocks":[...]}
data: {"diff_block":{"field":"blocks","patches":[{"op":"add",...}]}}
data: {"final":true}
data: [DONE]
```

**JSON Patch (RFC 6902)**:
- `op`: add, remove, replace, move, copy, test
- `path`: JSON Pointer (e.g., `/blocks/0/text`)
- `value`: New value for add/replace

### REST API

**Base URL**: `https://www.perplexity.ai`

**Authentication**: Cookie-based (`pplx.jwt`)

**Key Endpoints**:
- Threads: `/rest/threads` (CRUD)
- Entries: `/rest/entries/{uuid}` (get, update, delete)
- Collections: `/rest/collections` (CRUD)
- Social: `/rest/threads/{uuid}/like` (like, unlike)

**Pagination**: Cursor-based via `cursor` query param

## Common Pitfalls & Solutions

### Pitfall 1: SSE stream doesn't close
**Solution**: Always use `AbortController` and cleanup in `finally` block

### Pitfall 2: JSON Patch doesn't apply
**Solution**: Ensure paths use `/` separator and array indices as numbers

### Pitfall 3: Rate limiting not working
**Solution**: Use sliding window, not fixed window counters

### Pitfall 4: OAuth callback URL mismatch
**Solution**: Use exact redirect_uri from initial auth request

### Pitfall 5: Type inference fails
**Solution**: Explicitly type async generators: `AsyncGenerator<T, void, unknown>`

## References

- **Reverse-engineered sources**: 
  - `pplx-stream-D3-uFWQX.js` (SSE streaming)
  - `spa-shell-Cc8l94kf.js` (OAuth connectors)
  
- **Specs**:
  - RFC 6902 (JSON Patch)
  - Server-Sent Events (SSE)
  - OAuth 2.0

- **Existing PRs**:
  - PR #2: Documentation (merged)
  - PR #3: REST API + stubs (open)
  - PR #5: SSE streaming (open)

## When Implementing

1. **Read existing code first** - Understand patterns in `pplx-rest-client.ts` and `pplx-client.ts`
2. **Check types** - Reuse existing interfaces, don't duplicate
3. **Follow error handling** - Use custom error classes consistently
4. **Add JSDoc** - Document public APIs with examples
5. **Write tests** - Add unit tests alongside implementation
6. **Update exports** - Ensure `index.ts` exports new functionality
7. **Update README** - Add usage examples for new features

## Contact & Questions

If unclear on implementation details:
- Check existing code in `src/` for patterns
- Review reverse-engineered files in Space
- Reference protocol docs in `docs/`
- Ask for clarification via issue comments

---

**Last Updated**: 2026-01-19  
**SDK Version**: 1.0.0  
**Progress**: 85%
